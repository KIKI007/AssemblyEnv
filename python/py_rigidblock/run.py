import os
import polyscope as ps
from geometry import Assembly2D, Assembly2D_GUI
from assembly_env import AssemblyEnv
from multiprocessing import Process
from compas_eve import Message
from compas_eve import Subscriber
from compas_eve import Publisher
from compas_eve import Topic
from compas_eve.mqtt import MqttTransport
from stable_baselines3 import PPO
import time

import pickle
#parts = [[[14.0, 1.7320508075688772], [13.0, 1.7320508075688772], [13.5, 0.8660254037844386], [13.0, 0.0], [14.0, 0.0], [15.0, 0.0], [14.5, 0.8660254037844386], [15.0, 1.7320508075688772]], [[13.0, 3.4641016151377544], [12.0, 3.4641016151377544], [12.5, 2.598076211353316], [12.0, 1.7320508075688772], [13.0, 1.7320508075688772], [14.0, 1.7320508075688772], [13.5, 2.598076211353316], [14.0, 3.4641016151377544]], [[14.0, 5.196152422706632], [13.0, 5.196152422706631], [13.5, 4.330127018922193], [13.0, 3.4641016151377544], [14.0, 3.4641016151377544], [15.0, 3.4641016151377544], [14.5, 4.330127018922193], [15.0, 5.196152422706632]], [[15.0, 6.928203230275509], [14.0, 6.928203230275509], [14.5, 6.06217782649107], [14.0, 5.196152422706632], [15.0, 5.196152422706632], [16.0, 5.196152422706632], [15.5, 6.06217782649107], [16.0, 6.928203230275509]], [[14.0, 6.928203230275509], [13.0, 6.928203230275509], [12.5, 6.06217782649107], [13.0, 5.196152422706632], [14.0, 5.196152422706632], [14.5, 6.06217782649107]], [[12.5, 7.794228634059947], [11.5, 7.794228634059947], [12.0, 6.928203230275509], [12.5, 6.06217782649107], [13.0, 6.928203230275509], [14.0, 6.928203230275509], [13.5, 7.794228634059947], [13.0, 8.660254037844386]], [[11.5, 7.794228634059947], [10.5, 7.794228634059947], [10.0, 6.928203230275509], [10.5, 6.06217782649107], [11.5, 6.06217782649107], [12.0, 6.928203230275509]], [[11.5, 6.06217782649107], [10.5, 6.06217782649107], [11.0, 5.196152422706631], [11.5, 4.330127018922193], [12.0, 5.196152422706632], [13.0, 5.196152422706632], [12.5, 6.06217782649107], [12.0, 6.928203230275509]], [[13.0, 5.196152422706632], [12.0, 5.196152422706631], [11.5, 4.330127018922193], [12.0, 3.4641016151377544], [13.0, 3.4641016151377544], [13.5, 4.330127018922193]], [[10.5, 4.330127018922193], [9.5, 4.330127018922193], [10.0, 3.4641016151377544], [10.5, 2.598076211353316], [11.0, 3.4641016151377544], [12.0, 3.4641016151377544], [11.5, 4.330127018922193], [11.0, 5.196152422706631]], [[12.0, 3.4641016151377544], [11.0, 3.4641016151377544], [10.5, 2.598076211353316], [11.0, 1.7320508075688772], [12.0, 1.7320508075688772], [12.5, 2.598076211353316]], [[10.5, 2.598076211353316], [9.5, 2.598076211353316], [9.0, 1.7320508075688772], [9.5, 0.8660254037844386], [10.5, 0.8660254037844386], [11.0, 1.7320508075688772]], [[10.5, 0.8660254037844386], [9.5, 0.8660254037844386], [10.0, 0.0], [10.5, -0.8660254037844386], [11.0, 0.0], [12.0, 0.0], [11.5, 0.8660254037844386], [11.0, 1.7320508075688772]], [[8.5, 0.8660254037844386], [7.5, 0.8660254037844386], [8.0, 0.0], [8.5, -0.8660254037844386], [9.0, 0.0], [10.0, 0.0], [9.5, 0.8660254037844386], [9.0, 1.7320508075688772]], [[6.5, 0.8660254037844386], [5.5, 0.8660254037844386], [6.0, 0.0], [6.5, -0.8660254037844386], [7.0, 0.0], [8.0, 0.0], [7.5, 0.8660254037844386], [7.0, 1.7320508075688772]], [[5.0, 1.7320508075688772], [4.0, 1.7320508075688772], [4.5, 0.8660254037844386], [4.0, 0.0], [5.0, 0.0], [6.0, 0.0], [5.5, 0.8660254037844386], [6.0, 1.7320508075688772]], [[6.0, 3.4641016151377544], [5.0, 3.4641016151377544], [5.5, 2.598076211353316], [5.0, 1.7320508075688772], [6.0, 1.7320508075688772], [7.0, 1.7320508075688772], [6.5, 2.598076211353316], [7.0, 3.4641016151377544]], [[5.0, 3.4641016151377544], [4.0, 3.4641016151377544], [3.5, 2.598076211353316], [4.0, 1.7320508075688772], [5.0, 1.7320508075688772], [5.5, 2.598076211353316]], [[5.0, 5.196152422706632], [4.0, 5.196152422706631], [3.5, 4.330127018922193], [4.0, 3.4641016151377544], [5.0, 3.4641016151377544], [5.5, 4.330127018922193]], [[6.0, 5.196152422706632], [5.0, 5.196152422706631], [5.5, 4.330127018922193], [5.0, 3.4641016151377544], [6.0, 3.4641016151377544], [7.0, 3.4641016151377544], [6.5, 4.330127018922193], [7.0, 5.196152422706632]], [[6.0, 6.928203230275509], [5.0, 6.928203230275509], [4.5, 6.06217782649107], [5.0, 5.196152422706632], [6.0, 5.196152422706632], [6.5, 6.06217782649107]], [[5.0, 6.928203230275509], [6.0, 6.928203230275509], [6.5, 6.06217782649107], [7.0, 6.928203230275509], [7.5, 7.794228634059947], [6.5, 7.794228634059947], [6.0, 8.660254037844386], [5.5, 7.794228634059947]], [[6.0, 5.196152422706632], [7.0, 5.196152422706631], [7.5, 4.330127018922193], [8.0, 5.196152422706632], [8.5, 6.06217782649107], [7.5, 6.06217782649107], [7.0, 6.928203230275509], [6.5, 6.06217782649107]], [[8.5, 7.794228634059947], [7.5, 7.794228634059947], [7.0, 6.928203230275509], [7.5, 6.06217782649107], [8.5, 6.06217782649107], [9.0, 6.928203230275509]], [[9.5, 7.794228634059947], [8.5, 7.794228634059947], [9.0, 6.928203230275509], [8.5, 6.06217782649107], [9.5, 6.06217782649107], [10.5, 6.06217782649107], [10.0, 6.928203230275509], [10.5, 7.794228634059947]]]
#parts.extend([[[0.0, -0.8660254037844386], [5.0, -0.8660254037844386], [5.0, 0.0], [0.0, 0.0]], [[11.0, -0.8660254037844386], [15.0, -0.8660254037844386], [15.0, 0.0], [11.0, 0.0]]])

def train():
    parts = [[[4.0, 3.0], [5.0, 3.0], [5.0, 5.0], [4.0, 5.0], [4.0, 3.0]], [[0.0, 3.0], [1.0, 3.0], [1.0, 5.0], [0.0, 5.0], [0.0, 3.0]], [[2.0, 3.0], [3.0, 3.0], [3.0, 5.0], [2.0, 5.0], [2.0, 3.0]], [[2.0, 0.0], [3.0, 0.0], [3.0, 2.0], [2.0, 2.0], [2.0, 0.0]], [[0.0, 0.0], [1.0, 0.0], [1.0, 2.0], [0.0, 2.0], [0.0, 0.0]], [[4.0, 0.0], [5.0, 0.0], [5.0, 2.0], [4.0, 2.0], [4.0, 0.0]], [[0.0, 2.0], [5.0, 2.0], [5.0, 3.0], [0.0, 3.0], [0.0, 2.0]], [[0.0, 5.0], [5.0, 5.0], [5.0, 6.0], [0.0, 6.0], [0.0, 5.0]]]
    assembly = Assembly2D(parts)
    env = AssemblyEnv(assembly)
    TIMESTEP = 10000
    env.SEND_TIME = 0.1
    env.reset()

    model = PPO("MlpPolicy", env, verbose=1, tensorboard_log="./logs/")
    for epoch in range(100):
        env.NUM_ITER_SEND = TIMESTEP * 10
        model.learn(total_timesteps=TIMESTEP, tb_log_name="PPO", reset_num_timesteps= (epoch == 0))
        model.save(f"models/PPO/{epoch * TIMESTEP}")

    # model = PPO.load(f"models/PPO/{18000}.zip", env)

        env.NUM_ITER_SEND = 1
        obs, _ = env.reset()

        for it in range(8):
            action, _state = model.predict(obs, deterministic=True)
            obs, reward, terminated, truncated, info = env.step(action)

            if terminated or truncated:
                observation, info = env.reset()

def update_viewer(msg):
    global viewer
    viewer.update_status(msg["state"])

def gui():
    global viewer

    parts = [[[4.0, 3.0], [5.0, 3.0], [5.0, 5.0], [4.0, 5.0], [4.0, 3.0]], [[0.0, 3.0], [1.0, 3.0], [1.0, 5.0], [0.0, 5.0], [0.0, 3.0]], [[2.0, 3.0], [3.0, 3.0], [3.0, 5.0], [2.0, 5.0], [2.0, 3.0]], [[2.0, 0.0], [3.0, 0.0], [3.0, 2.0], [2.0, 2.0], [2.0, 0.0]], [[0.0, 0.0], [1.0, 0.0], [1.0, 2.0], [0.0, 2.0], [0.0, 0.0]], [[4.0, 0.0], [5.0, 0.0], [5.0, 2.0], [4.0, 2.0], [4.0, 0.0]], [[0.0, 2.0], [5.0, 2.0], [5.0, 3.0], [0.0, 3.0], [0.0, 2.0]], [[0.0, 5.0], [5.0, 5.0], [5.0, 6.0], [0.0, 6.0], [0.0, 5.0]]]
    viewer = Assembly2D_GUI(parts)


    ps.init()
    ps.set_navigation_style("turntable")
    ps.set_ground_plane_mode("shadow_only")
    ps.set_up_dir("z_up")
    ps.look_at((0., -5., 3.5), (0., 0., 0.))

    tx = MqttTransport("localhost")
    topic = Topic("/rl/sequence/", Message)
    subscriber = Subscriber(topic, callback=update_viewer, transport=tx)
    subscriber.subscribe()

    viewer.render()
    ps.set_user_callback(viewer.interface)

    ps.show()

if __name__ == "__main__":
    p1 = Process(target=gui)
    p2 = Process(target=train)
    #
    p1.start()
    p2.start()
    p1.join()
    p1.join()